___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "StackAdapt Server-Side Pixel",
  "categories": ["ADVERTISING","CONVERSIONS","REMARKETING"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "StackAdapt server-side pixel allows the implementation of retargeting, conversion tracking, and lookalike targeting in both universal event and standalone formats",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixelID",
    "displayName": "The Unique ID of the Retargeting audience, Lookalike audience, or Conversion Event, or Universal Pixel",
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "pixelType",
    "displayName": "",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "rt",
        "displayValue": "Retargeting Audience"
      },
      {
        "value": "lal",
        "displayValue": "Lookalike Audience"
      },
      {
        "value": "conv",
        "displayValue": "Conversion Event"
      },
      {
        "value": "universal",
        "displayValue": "Universal Event"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "commonProperties",
    "displayName": "",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Standard Properties",
        "name": "name",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "email",
            "displayValue": "Email"
          },
          {
            "value": "first_name",
            "displayValue": "First Name"
          },
          {
            "value": "last_name",
            "displayValue": "Last Name"
          },
          {
            "value": "phone",
            "displayValue": "Phone Number"
          },
          {
            "value": "order_id",
            "displayValue": "Order ID"
          },
          {
            "value": "revenue",
            "displayValue": "Order Revenue"
          },
          {
            "value": "product_id",
            "displayValue": "Product ID"
          },
          {
            "value": "product_name",
            "displayValue": "Product Name"
          },
          {
            "value": "product_price",
            "displayValue": "Product Price"
          },
          {
            "value": "product_category",
            "displayValue": "Product Category"
          },
          {
            "value": "action",
            "displayValue": "Action"
          }
        ]
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "value",
        "type": "TEXT"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "customProperties",
    "displayName": "",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Custom Properties",
        "name": "name",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "value",
        "type": "TEXT"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const JSON = require('JSON');
const sendHttpRequest = require('sendHttpRequest');
const getAllEventData = require('getAllEventData');
const makeInteger = require('makeInteger');
const makeString = require('makeString');
const generateRandom = require('generateRandom');
const getContainerVersion = require('getContainerVersion');
const getTimestampMillis = require('getTimestampMillis');
const getRemoteAddress = require('getRemoteAddress');
const getEventData = require('getEventData');
const getCookieValues = require('getCookieValues');
const getRequestHeader = require('getRequestHeader');
const setCookie = require('setCookie');
const encodeUriComponent = require('encodeUriComponent');
const logToConsole = require('logToConsole');
const userIdVersion = 'v1';
const saApiRevision = '2023-test';
const Object = require('Object');

const customProperties = {
	'email':true,
	'first_name':true,
	'last_name':true,
	'phone':true,
	'revenue':true,
	'order_id':true,
	'product_id':true,
	'product_name':true,
	'product_price':true,
	'product_category':true,
	'action':true,
};

if (data.pixelType == 'rt') {
	sendRt();
} else if (data.pixelType == 'drt') {
	sendRt();
} else if (data.pixelType == 'conv') {
	sendConv();
} else if (data.pixelType == 'lal') {
	sendLal();
} else {
	sendUniversal();
}

function sendRequest(url) {
	sendHttpRequest(
		url,
		(statusCode, headers, body) => {
      	  if (isLoggingEnabled()) {
	        logToConsole(
	          JSON.stringify({
	            Name: 'StackAdapt',
	            Type: 'Request',
	            TraceId: getRequestHeader('trace-id'),
	            RequestMethod: 'GET',
	            RequestUrl: url,
	          })
	        );
	      }

		  if (statusCode >= 200 && statusCode < 300) {
            data.gtmOnSuccess();
          } else {
            data.gtmOnFailure();
          }
		},
		{ 
			headers:{
				'X-Forwarded-For': getIP(),
				'Revision': saApiRevision,
				'User-Agent': getEventData('user_agent') || '',
			},
			method: 'GET' 
		}
	);

}

function addCustomProperties(pixel_type){
	let args = {};

	const eventData = require('getAllEventData');

	for (let key in eventData) {
		if (customProperties[key]) {
			args[key] = eventData[key];
		}
	}

	//logToConsole(JSON.stringify(eventData));

	if (eventData.user_data) {
		if (!args.email && eventData.user_data.email_address) {
			args.email = eventData.user_data.email_address;
		}
		if (!args.phone && eventData.user_data.phone_number) {
			args.phone = eventData.user_data.phone_number;
		}
		if (!args.first_name && eventData.user_data.first_name) {
			args.first_name = eventData.user_data.first_name;
		}
		if (!args.last_name && eventData.user_data.last_name) {
			args.last_name = eventData.user_data.last_name;
		}
	}

  if (data.commonProperties) {
    for (let key in data.commonProperties) {
      args[data.commonProperties[key].name] = data.commonProperties[key].value;
    }
  }

  if (data.customProperties) {
    for (let key in data.customProperties) {
      args[data.customProperties[key].name] = data.customProperties[key].value;
    }
  }

	if (Object.keys(args).length == 0) {
		return "";
	}

	if (pixel_type != "conv") {
		return "&args="+encodeUriComponent(JSON.stringify(args));
	} else {
		let url_params = "";
  	for (var key in args) {
      var val = args[key];
      if (key.indexOf("sa_conv_data_") != 0) {
      	key = "sa_conv_data_" + key;
      }
      url_params += "&" + encodeUriComponent(key);
      url_params += "=" + encodeUriComponent(val);
  	}
  	return url_params;
	}

}

function buildUrl(pixel_type) {
	let sa_url = 'https://tags.srv.stackadapt.com/' + pixel_type;
	let page_url = getEventData('page_location') || getRequestHeader('referer') || '';
	let ip_address = getIP();
	let page_ref = getEventData('page_referrer') || '';
	let title = getEventData('page_title') || '';
	let campaign_source = getEventData('campaign_source') || '';
	let engagement_time = getEventData('engagement_time_msec') || '';
	if (pixel_type == 'rt' || pixel_type == 'drt' || pixel_type == 'lal'){
		sa_url = sa_url + "?sid=" + data.pixelID;
	} else if (pixel_type == 'conv'){
		sa_url = sa_url + "?cid=" + data.pixelID;
	} else {
		sa_url = sa_url + "?uid=" + data.pixelID;
	}
	let user_id = getSetUserId();

	return sa_url + "&gtm_ss=1&ip_fwd=" + encodeUriComponent(ip_address) + "&url=" + encodeUriComponent(page_url) + 
		"&ref" + encodeUriComponent(page_ref) + "&title=" + encodeUriComponent(title) + "&utm_source=" + encodeUriComponent(campaign_source) + 
		"&engage_time=" + encodeUriComponent(engagement_time) + "&user_id=" + encodeUriComponent(user_id) + addCustomProperties(pixel_type);
}

function sendRt() {
	sendRequest(buildUrl('rt'));
}

function sendDrt() {
	sendRequest(buildUrl('drt'));	
}

function sendConv() {
	sendRequest(buildUrl('conv')+addPostbackId());
}

function sendLal() {
	sendRequest(buildUrl('lal'));
}

function sendUniversal() { 
	sendRequest(buildUrl('saq_pxl'));
}

function addPostbackId() { 
	let postback_id = getCookieValues('sa-postbackid')[0];
  if (postback_id) {
  	return "&postback_id="+postback_id;
  }
  return "";
}

function isLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
      containerVersion &&
      (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}	


function getIP(){
	return getEventData('ip_override') || getRemoteAddress() || '';
}

function getSetUserId() { 
  let user_id = getCookieValues('sa-userid')[0];
  if (user_id) {
  	return user_id;
  }
  user_id = 'sa-' + userIdVersion + '-' + createUUID() + '.' + getTimestampMillis();

  const cookieOptions = {
    domain: 'auto',
    path: '/',
    samesite: 'Lax',
    secure: true,
    'max-age': 31536000, // 1 year
    httpOnly: !!data.useHttpOnlyCookie
  };

  setCookie('sa-userid',user_id,cookieOptions);
  return user_id;
}

function createUUID() {
  let len = 12;
  let chars = '0123456789abcdef'.split('');
  let uuid = '';

  for (var i = 0; i < len; i++) {
     uuid += chars[generateRandom(0, chars.length - 1)];
  }
  return uuid;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "sa-userid"
              },
              {
                "type": 1,
                "string": "sa-postbackid"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sa-userid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.srv.stackadapt.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 8/28/2023, 4:59:30 PM


